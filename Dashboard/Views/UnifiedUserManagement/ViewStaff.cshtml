@model List<Core.Models.DTO.UnifiedUserDto>
@{
    ViewData["Title"] = "Staff Management";
    var staffRoles = ViewBag.StaffRoles as List<Core.Models.DTO.RoleDto> ?? new List<Core.Models.DTO.RoleDto>();
}

<style>
.management-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .panel {
        background: var(--bg2);
        backdrop-filter: blur(20px);
        border: 1px solid var(--bg1);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .search-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .search-input {
        flex: 1;
        background: var(--bg3);
        border: 1px solid var(--bg5);
        color: white;
        padding: 0.75rem;
        border-radius: 10px;
        transition: all 0.5s ease-in-out;
    }

        .search-input::placeholder {
            color: var(--form-c1);
        }

        .search-input:focus {
            background: var(--bg4);
            outline: none;
            border-color: white;
        }

    .btn-glass {
        background: var(--bg1);
        border: 1px solid var(--bg1);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
        font-weight: 500;
        cursor: pointer;
        border: none;
    }

        .btn-glass:hover {
            background: var(--bg4);
            transform: translateY(-2px);
            color: white;
        }

    .btn-primary {
        background: var(--btn-p1);
        border: 1px solid var(--btn-p2);
    }

        .btn-primary:hover {
            background: var(--btn-p2);
        }

    .btn-danger {
        background: var(--btn-d1);
        border: 1px solid var(--btn-d2);
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

        .btn-danger:hover {
            background: var(--btn-d2);
        }

    .user-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

        .user-table th,
        .user-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--bg1);
        }

        .user-table th {
            font-weight: 600;
            background: var(--bg2);
        }

        .user-table tr:hover {
            background: var(--bg5);
        }

    .role-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 600;
        background: var(--btn-p1);
        border: 1px solid var(--btn-p2);
    }

        .role-badge.admin {
            background: var(--btn-d1);
            border: 1px solid var(--btn-d1);
        }

    .alert-glass {
        background: var(--bg1);
        border: 1px solid var(--bg1);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .alert-success {
        background: var(--alert-s1);
        border-color: var(--alert-s2);
    }

    .alert-danger {
        background: var(--alert-d1);
        border-color: var(--alert-d2);
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: var(--bg6);
        /*backdrop-filter: blur(10px);*/        /*removed for performance issues*/
    }

    .modal-content {
        background: linear-gradient(145deg, var(--primary), var(--secondary));
        margin: 5rem auto;
        padding: 2rem;
        border-radius: 20px;
        max-width: 600px;
        border: 1px solid var(--bg1);
    }

    .close {
        color: white;
        float: right;
        font-size: 2rem;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }

        .close:hover {
            opacity: 0.7;
        }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        background: var(--bg3);
        border: 1px solid var(--bg1);
        color: white;
        padding: 0.75rem;
        border-radius: 8px;
    }

        .form-control::placeholder {
            color: var(--form-c1);
        }

        .form-control:focus {
            background: var(--bg1);
            outline: none;
            border-color: white;
        }

    .form-select {
        width: 100%;
        background: var(--bg3);
        border: 1px solid var(--bg1);
        color: white;
        padding: 0.75rem;
        border-radius: 8px;
    }

        .form-select option {
            background: var(--primary);
            color: white;
        }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .back-link {
        color: var(--back-link);
        text-decoration: none;
        margin-bottom: 1rem;
        display: inline-block;
    }

        .back-link:hover {
            color: white;
        }

    .btn-update{
        font-size: 0.875rem;
        width:fit-content;
    }
</style>

<div class="management-container">
    <a asp-action="Index" class="back-link">← Back to User Management</a>

    <h1 class="mb-4">Staff Management</h1>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-glass">
            @TempData["Success"]
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-glass">
            @TempData["Error"]
        </div>
    }

    <div class="panel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Staff Members</h2>
            <button class="btn-glass btn-primary" onclick="openCreateModal()">+ Add New Staff</button>
        </div>

        <form method="get" asp-action="ViewStaff">
            <div class="search-bar">
                <input type="text" name="searchTerm" class="search-input" placeholder="Search by name or email..." value="@ViewBag.CurrentSearch" />
                <button type="submit" class="btn-glass">Search</button>
                @if (!string.IsNullOrEmpty(ViewBag.CurrentSearch as string))
                {
                    <a asp-action="ViewStaff" class="btn-glass">Clear</a>
                }
            </div>
        </form>

        @if (Model != null && Model.Any())
        {
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model)
                    {
                        <tr>
                            <td>@user.FirstName</td>
                            <td>@user.Email</td>
                            <td>@user.Phone</td>
                            <td>
                                <span class="role-badge @(user.RoleName.ToLower() == "admin" ? "admin" : "")">
                                    @user.RoleName
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-glass btn-update"
                                            onclick="openUpdateModal('@user.Id','@user.FirstName','@user.Email','@user.Phone','@user.RoleId')">
                                        Update
                                    </button>
                                    <button class="btn-glass btn-danger" onclick="confirmDelete('@user.Id', '@user.FirstName')">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p class="text-center mt-4">No staff members found.</p>
        }
    </div>
</div>

<div id="createModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeCreateModal()">&times;</span>
        <h2 class="mb-4">Create New Staff Member</h2>
        <form asp-action="CreateStaff" method="post">
            @Html.AntiForgeryToken()
            <div class="form-group">
                <label class="form-label" for="FirstName">First Name *</label>
                <input type="text" name="FirstName" id="FirstName" class="form-control" required />
            </div>
            <div class="form-group">
                <label class="form-label" for="Email">Email *</label>
                <input type="email" name="Email" id="Email" class="form-control" required />
            </div>
            <div class="form-group">
                <label class="form-label" for="Phone">Phone *</label>
                <input type="tel" name="Phone" id="Phone" class="form-control" required />
            </div>
            <div class="form-group">
                <label class="form-label" for="Password">Password *</label>
                <input type="password" name="Password" id="Password" class="form-control" required />
            </div>
            <div class="form-group">
                <label class="form-label" for="Role">Role *</label>
                <select name="RoleId" id="Role" class="form-select" required>
                    <option value="">Select a role...</option>
                    @foreach (var role in staffRoles)
                    {
                        <option value="@role.Id">@role.Name - @role.Description</option>
                    }
                </select>
            </div>
            <button type="submit" class="btn-glass btn-primary w-100">Create Staff Member</button>
        </form>
    </div>
</div>

<div id="updateModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeUpdateModal()">&times;</span>
        <h2 class="mb-4">Update Staff Member</h2>
        <form asp-action="UpdateStaff" method="post" id="updateForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="Id" id="Update_Id" />
            <div class="form-group">
                <label class="form-label" for="Update_FirstName">First Name (optional)</label>
                <input type="text" name="FirstName" id="Update_FirstName" class="form-control" />
            </div>
            <div class="form-group">
                <label class="form-label" for="Update_Email">Email (optional)</label>
                <input type="email" name="Email" id="Update_Email" class="form-control" />
            </div>
            <div class="form-group">
                <label class="form-label" for="Update_Phone">Phone (optional)</label>
                <input type="tel" name="Phone" id="Update_Phone" class="form-control" />
            </div>
            <div class="form-group">
                <label class="form-label" for="Update_Role">Role (optional)</label>
                <select name="RoleId" id="Update_Role" class="form-select">
                    <option value="">Select a role...</option>
                    @foreach (var role in (List<Core.Models.DTO.RoleDto>)(ViewBag.StaffRoles ?? new List<Core.Models.DTO.RoleDto>()))
                    {
                        <option value="@role.Id">@role.Name - @role.Description</option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="Update_NewPassword">New Password (optional)</label>
                <input type="password" name="NewPassword" id="Update_NewPassword" class="form-control" placeholder="Leave blank to keep current password" />
            </div>
            <button type="submit" class="btn-glass btn-primary w-100">Save Changes</button>
        </form>
    </div>
</div>



<form id="deleteForm" method="post" style="display: none;">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        function openCreateModal() {
            document.getElementById('createModal').style.display = 'block';
        }

        function closeCreateModal() {
            document.getElementById('createModal').style.display = 'none';
        }

        function confirmDelete(userId, userName) {
            if (confirm(`Are you sure you want to delete staff member "${userName}"? This action cannot be undone.`)) {
                const form = document.getElementById('deleteForm');
                form.action = '@Url.Action("DeleteStaff", "UnifiedUserManagement")/' + userId;
                form.submit();
            }
        }

        function openUpdateModal(id, firstName, email, phone, roleId) {
            document.getElementById('Update_Id').value = id;
            document.getElementById('Update_FirstName').value = firstName || '';
            document.getElementById('Update_Email').value = email || '';
            document.getElementById('Update_Phone').value = phone || '';
            document.getElementById('Update_Role').value = roleId || '';
            document.getElementById('Update_NewPassword').value = '';
            document.getElementById('updateModal').style.display = 'block';
        }
        function closeUpdateModal() {
            document.getElementById('updateModal').style.display = 'none';
        }

                // Only close when clicking directly on the overlay, never from inside content this fixes the issue of windows onclick closing the modal when trying to drag content within the modal
        (function modalClickGuards() {
            const createModal = document.getElementById('createModal');
            const updateModal = document.getElementById('updateModal');

            if (createModal) {
                createModal.addEventListener('click', function (e) {
                    if (e.target === createModal) closeCreateModal();
                });
                const createContent = createModal.querySelector('.modal-content');
                if (createContent) createContent.addEventListener('click', function (e) { e.stopPropagation(); });
            }

            if (updateModal) {
                updateModal.addEventListener('click', function (e) {
                    if (e.target === updateModal) closeUpdateModal();
                });
                const updateContent = updateModal.querySelector('.modal-content');
                if (updateContent) updateContent.addEventListener('click', function (e) { e.stopPropagation(); });
            }
        })();
    </script>
}